<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analyzer AI</title>
    
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@8/css/ionic.bundle.css" />
    
    <style>
        :root {
            --ion-color-primary: #3880ff;
            --ion-color-success: #2dd36f;
            --ion-color-warning: #ffc409;
            --ion-color-danger: #eb445a;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }
        
        .code-editor {
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            min-height: 200px;
            padding: 12px;
            background: #f9f9f9;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .analysis-item {
            margin-bottom: 12px;
            padding: 12px;
            border-left: 4px solid var(--ion-color-primary);
            background: white;
            border-radius: 4px;
        }
        
        .fixed-code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .rating-good { background: var(--ion-color-success); color: white; }
        .rating-medium { background: var(--ion-color-warning); color: black; }
        .rating-poor { background: var(--ion-color-danger); color: white; }
        
        .list-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <ion-app>
        <ion-header>
            <ion-toolbar color="primary">
                <ion-title>AI Code Analyzer</ion-title>
            </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
            <div class="container">
                <ion-card>
                    <ion-card-header>
                        <ion-card-title>Analisis Kode AI</ion-card-title>
                        <ion-card-subtitle>Analisis, perbaiki, dan optimasi kode dengan AI</ion-card-subtitle>
                    </ion-card-header>
                    
                    <ion-card-content>
                        <ion-grid>
                            <ion-row>
                                <ion-col size="12" size-md="6">
                                    <ion-item>
                                        <ion-label position="stacked">Bahasa Pemrograman</ion-label>
                                        <ion-select value="javascript" id="languageSelect">
                                            <ion-select-option value="javascript">JavaScript</ion-select-option>
                                            <ion-select-option value="python">Python</ion-select-option>
                                            <ion-select-option value="java">Java</ion-select-option>
                                            <ion-select-option value="cpp">C++</ion-select-option>
                                            <ion-select-option value="c">C</ion-select-option>
                                            <ion-select-option value="auto">Auto-detect</ion-select-option>
                                        </ion-select>
                                    </ion-item>
                                </ion-col>
                                
                                <ion-col size="12" size-md="6">
                                    <ion-item>
                                        <ion-label position="stacked">Tugas Analisis</ion-label>
                                        <ion-select value="analyze" id="taskSelect">
                                            <ion-select-option value="analyze">Analisis Kode</ion-select-option>
                                            <ion-select-option value="fix">Perbaiki Error</ion-select-option>
                                            <ion-select-option value="optimize">Optimasi</ion-select-option>
                                            <ion-select-option value="refactor">Refactor</ion-select-option>
                                            <ion-select-option value="explain">Jelaskan Kode</ion-select-option>
                                        </ion-select>
                                    </ion-item>
                                </ion-col>
                            </ion-row>
                            
                            <ion-row>
                                <ion-col size="12">
                                    <ion-item>
                                        <ion-label position="stacked">URL GitHub (Opsional)</ion-label>
                                        <ion-input type="url" id="githubUrl" placeholder="https://github.com/user/repo/blob/main/file.js"></ion-input>
                                    </ion-item>
                                </ion-col>
                            </ion-row>
                            
                            <ion-row>
                                <ion-col size="12">
                                    <ion-item>
                                        <ion-label position="stacked">Kode Sumber</ion-label>
                                    </ion-item>
                                    <div class="code-editor" contenteditable="true" id="codeInput">// Masukkan kode Anda di sini
function example(a, b) {
    return a + b;
}

console.log(example(5, 10));</div>
                                </ion-col>
                            </ion-row>
                            
                            <ion-row>
                                <ion-col size="12">
                                    <ion-button expand="block" color="primary" id="analyzeBtn">
                                        <ion-icon slot="start" name="analytics"></ion-icon>
                                        Analisis Kode
                                    </ion-button>
                                </ion-col>
                            </ion-row>
                        </ion-grid>
                    </ion-card-content>
                </ion-card>

                <div id="resultsSection" style="display: none;">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title>Hasil Analisis</ion-card-title>
                            <ion-card-subtitle id="resultSubtitle"></ion-card-subtitle>
                        </ion-card-header>
                        
                        <ion-card-content>
                            <div id="analysisResults"></div>
                        </ion-card-content>
                    </ion-card>
                </div>
            </div>
        </ion-content>
    </ion-app>

    <script>
        const CONFIG = {
            WORKER_URL: 'https://oktokit-ai.androidbutut.workers.dev/analyze'
        };

        // Get elements
        const codeInput = document.getElementById('codeInput');
        const languageSelect = document.getElementById('languageSelect');
        const taskSelect = document.getElementById('taskSelect');
        const githubUrl = document.getElementById('githubUrl');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultsSection = document.getElementById('resultsSection');
        const resultSubtitle = document.getElementById('resultSubtitle');
        const analysisResults = document.getElementById('analysisResults');

        // Attach event listener
        analyzeBtn.addEventListener('click', analyzeCode);

        async function analyzeCode() {
            const code = codeInput.textContent.trim();
            const language = languageSelect.value;
            const task = taskSelect.value;
            const githubUrlValue = githubUrl.value.trim();

            console.log('Analysis request:', { hasCode: !!code, language, task, githubUrlValue });

            if (!code && !githubUrlValue) {
                showError('Masukkan kode atau URL GitHub');
                return;
            }

            const loading = await createLoading(githubUrlValue);
            
            try {
                const payload = { task };

                if (language !== 'auto') {
                    payload.language = language;
                }

                if (githubUrlValue) {
                    if (!isValidGitHubUrl(githubUrlValue)) {
                        throw new Error('Format URL GitHub tidak valid');
                    }
                    payload.githubUrl = githubUrlValue;
                } else {
                    payload.code = code;
                }

                console.log('Sending request...');

                const response = await fetch(CONFIG.WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    let errorMessage = `Server error: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        if (errorData.details) {
                            errorMessage += `\n${errorData.details}`;
                        }
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('Result:', result);
                displayResults(result, task, githubUrlValue);

            } catch (error) {
                console.error('Error:', error);
                showError(`Gagal: ${error.message}`);
            } finally {
                loading.dismiss();
            }
        }

        async function createLoading(isGithub) {
            const loading = document.createElement('ion-loading');
            loading.message = isGithub ? 
                'Mengambil dari GitHub...' : 
                'Menganalisis kode...';
            loading.duration = 0;
            document.body.appendChild(loading);
            await loading.present();
            return loading;
        }

        function isValidGitHubUrl(url) {
            try {
                const parsed = new URL(url);
                return parsed.hostname === 'github.com' && 
                       parsed.pathname.split('/').length >= 3;
            } catch {
                return false;
            }
        }

        async function showError(message) {
            const alert = document.createElement('ion-alert');
            alert.header = 'Error';
            alert.message = message;
            alert.buttons = ['OK'];
            document.body.appendChild(alert);
            await alert.present();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayResults(result, task, githubUrl) {
            resultsSection.style.display = 'block';
            
            const taskNames = {
                analyze: 'Analisis Kode',
                fix: 'Perbaikan Kode', 
                optimize: 'Optimasi Kode',
                refactor: 'Refactoring Kode',
                explain: 'Penjelasan Kode'
            };

            resultSubtitle.textContent = taskNames[task] || 'Analisis Kode';

            let html = '';

            if (result.error || result.parse_error) {
                html = `
                    <div class="analysis-item" style="border-left-color: var(--ion-color-danger);">
                        <h3>‚ö†Ô∏è Error</h3>
                        <p>${escapeHtml(result.error || result.parse_error)}</p>
                        ${result.raw_response ? `<pre style="background:#f5f5f5;padding:12px;overflow-x:auto;">${escapeHtml(result.raw_response)}</pre>` : ''}
                    </div>
                `;
            } else {
                switch (task) {
                    case 'analyze':
                        html = renderAnalysis(result);
                        break;
                    case 'fix':
                        html = renderFix(result);
                        break;
                    case 'optimize':
                        html = renderOptimization(result);
                        break;
                    case 'refactor':
                        html = renderRefactor(result);
                        break;
                    case 'explain':
                        html = renderExplanation(result);
                        break;
                    default:
                        html = renderDefault(result);
                }
            }

            analysisResults.innerHTML = html;
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function renderAnalysis(result) {
            const analysis = result.analysis || {};
            const rating = analysis.rating || 0;
            const ratingClass = rating >= 7 ? 'rating-good' : rating >= 5 ? 'rating-medium' : 'rating-poor';
            
            return `
                <div class="analysis-item">
                    <h3>üìä Kualitas Kode <span class="rating-badge ${ratingClass}">${rating}/10</span></h3>
                    <p>${escapeHtml(analysis.quality || 'Tidak ada informasi')}</p>
                </div>
                
                ${renderList('üêõ Bugs Ditemukan', analysis.bugs)}
                ${renderList('üîí Keamanan', analysis.security)}
                ${renderList('‚ö° Performa', analysis.performance)}
                ${renderList('‚úÖ Best Practices', analysis.best_practices)}
                
                <div class="analysis-item">
                    <h3>üìù Ringkasan</h3>
                    <p>${escapeHtml(result.summary || 'Tidak ada ringkasan')}</p>
                </div>
                
                ${renderList('üí° Saran', result.suggestions)}
            `;
        }

        function renderFix(result) {
            return `
                ${renderList('üêõ Error Ditemukan', result.errors_found)}
                
                <div class="analysis-item">
                    <h3>üîß Kode yang Diperbaiki</h3>
                    <div class="fixed-code">${escapeHtml(result.fixed_code || 'Tidak ada kode')}</div>
                </div>
                
                <div class="analysis-item">
                    <h3>üí¨ Penjelasan Perbaikan</h3>
                    <p>${escapeHtml(result.fix_explanation || 'Tidak ada penjelasan')}</p>
                </div>
                
                <div class="analysis-item">
                    <h3>üß™ Testing Notes</h3>
                    <p>${escapeHtml(result.testing_notes || 'Tidak ada catatan testing')}</p>
                </div>
            `;
        }

        function renderOptimization(result) {
            return `
                <div class="analysis-item">
                    <h3>‚ö° Kode Teroptimasi</h3>
                    <div class="fixed-code">${escapeHtml(result.optimized_code || 'Tidak ada kode')}</div>
                </div>
                
                ${renderList('üöÄ Optimasi Dilakukan', result.optimizations)}
                
                <div class="analysis-item">
                    <h3>üìà Peningkatan Performa</h3>
                    <p>${escapeHtml(result.performance_improvement || 'Tidak ada informasi')}</p>
                </div>
                
                <div class="analysis-item">
                    <h3>‚öñÔ∏è Tradeoffs</h3>
                    <p>${escapeHtml(result.tradeoffs || 'Tidak ada tradeoffs')}</p>
                </div>
            `;
        }

        function renderRefactor(result) {
            return `
                <div class="analysis-item">
                    <h3>üîÑ Kode Refactored</h3>
                    <div class="fixed-code">${escapeHtml(result.refactored_code || 'Tidak ada kode')}</div>
                </div>
                
                ${renderList('üîß Perubahan Refactoring', result.refactoring_changes)}
                
                <div class="analysis-item">
                    <h3>üìñ Peningkatan Readability</h3>
                    <p>${escapeHtml(result.readability_improvement || 'Tidak ada informasi')}</p>
                </div>
                
                <div class="analysis-item">
                    <h3>üõ†Ô∏è Maintainability</h3>
                    <p>${escapeHtml(result.maintainability_notes || 'Tidak ada catatan')}</p>
                </div>
            `;
        }

        function renderExplanation(result) {
            return `
                <div class="analysis-item">
                    <h3>üéØ Tujuan Keseluruhan</h3>
                    <p>${escapeHtml(result.overall_purpose || 'Tidak ada informasi')}</p>
                </div>
                
                ${renderList('üìù Penjelasan Per Baris', result.line_by_line)}
                
                <div class="analysis-item">
                    <h3>üßÆ Algoritma Kunci</h3>
                    <p>${escapeHtml(result.key_algorithms || 'Tidak ada informasi')}</p>
                </div>
                
                ${renderList('üíº Use Cases', result.use_cases)}
                
                <div class="analysis-item">
                    <h3>‚è±Ô∏è Analisis Kompleksitas</h3>
                    <p>${escapeHtml(result.complexity_analysis || 'Tidak ada analisis')}</p>
                </div>
            `;
        }

        function renderList(title, items) {
            if (!items || !Array.isArray(items) || items.length === 0) {
                return '';
            }
            
            const listHtml = items.map(item => 
                `<div class="list-item">${escapeHtml(item)}</div>`
            ).join('');
            
            return `
                <div class="analysis-item">
                    <h3>${title}</h3>
                    ${listHtml}
                </div>
            `;
        }

        function renderDefault(result) {
            return `
                <div class="analysis-item">
                    <h3>üìÑ Hasil</h3>
                    <pre style="background:#f5f5f5;padding:12px;overflow-x:auto;">${escapeHtml(JSON.stringify(result, null, 2))}</pre>
                </div>
            `;
        }
    </script>
</body>
</html>
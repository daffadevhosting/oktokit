<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Analyzer AI</title>
    
    <!-- Ionic Core CDN -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@8/css/ionic.bundle.css" />
    
    <!-- Custom CSS -->
    <style>
        :root {
            --ion-color-primary: #3880ff;
            --ion-color-success: #2dd36f;
            --ion-color-warning: #ffc409;
            --ion-color-danger: #eb445a;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }
        
        .code-editor {
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            min-height: 200px;
            padding: 12px;
        }
        
        .result-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .analysis-item {
            margin-bottom: 12px;
            padding: 12px;
            border-left: 4px solid var(--ion-color-primary);
            background: white;
        }
        
        .fixed-code {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
        }
        
        .rating-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .rating-good { background: var(--ion-color-success); color: white; }
        .rating-medium { background: var(--ion-color-warning); color: black; }
        .rating-poor { background: var(--ion-color-danger); color: white; }
    </style>
</head>
<body>
    <ion-app>
        <ion-header>
            <ion-toolbar color="primary">
                <ion-title>AI Code Analyzer</ion-title>
                <ion-buttons slot="end">
                    <ion-button id="themeToggle">
                        <ion-icon slot="icon-only" name="contrast"></ion-icon>
                    </ion-button>
                </ion-buttons>
            </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
            <div class="container">
                <!-- Input Section -->
                <ion-card>
                    <ion-card-header>
                        <ion-card-title>Analisis Kode AI</ion-card-title>
                        <ion-card-subtitle>Analisis, perbaiki, dan optimasi kode dengan AI</ion-card-subtitle>
                    </ion-card-header>
                    
                    <ion-card-content>
                        <ion-grid>
                            <ion-row>
                                <ion-col size="12" size-md="6">
                                    <ion-item>
                                        <ion-label position="stacked">Bahasa Pemrograman</ion-label>
                                        <ion-select value="javascript" id="languageSelect">
                                            <ion-select-option value="javascript">JavaScript</ion-select-option>
                                            <ion-select-option value="python">Python</ion-select-option>
                                            <ion-select-option value="java">Java</ion-select-option>
                                            <ion-select-option value="cpp">C++</ion-select-option>
                                            <ion-select-option value="c">C</ion-select-option>
                                            <ion-select-option value="auto">Auto-detect</ion-select-option>
                                        </ion-select>
                                    </ion-item>
                                </ion-col>
                                
                                <ion-col size="12" size-md="6">
                                    <ion-item>
                                        <ion-label position="stacked">Tugas Analisis</ion-label>
                                        <ion-select value="analyze" id="taskSelect">
                                            <ion-select-option value="analyze">Analisis Kode</ion-select-option>
                                            <ion-select-option value="fix">Perbaiki Error</ion-select-option>
                                            <ion-select-option value="optimize">Optimasi</ion-select-option>
                                            <ion-select-option value="refactor">Refactor</ion-select-option>
                                            <ion-select-option value="explain">Jelaskan Kode</ion-select-option>
                                        </ion-select>
                                    </ion-item>
                                </ion-col>
                            </ion-row>
                            
                            <ion-row>
                                <ion-col size="12">
                                    <ion-item>
                                        <ion-label position="stacked">URL GitHub (Opsional)</ion-label>
                                        <ion-input type="url" id="githubUrl" placeholder="https://github.com/user/repo/blob/main/file.js"></ion-input>
                                    </ion-item>
                                </ion-col>
                            </ion-row>
                            
                            <ion-row>
                                <ion-col size="12">
                                    <ion-item>
                                        <ion-label position="stacked">Kode Sumber</ion-label>
                                    </ion-item>
                                    <div class="code-editor" contenteditable="true" id="codeInput">
// Masukkan kode Anda di sini
function example(a, b) {
    return a + b;
}

console.log(example(5, 10));
                                    </div>
                                </ion-col>
                            </ion-row>
                            
                            <ion-row>
                                <ion-col size="12">
                                    <ion-button expand="block" color="primary" id="analyzeBtn">
                                        <ion-icon slot="start" name="analytics"></ion-icon>
                                        Analisis Kode
                                    </ion-button>
                                </ion-col>
                            </ion-row>
                        </ion-grid>
                    </ion-card-content>
                </ion-card>

                <!-- Results Section -->
                <div id="resultsSection" style="display: none;">
                    <ion-card>
                        <ion-card-header>
                            <ion-card-title>Hasil Analisis</ion-card-title>
                            <ion-card-subtitle id="resultSubtitle"></ion-card-subtitle>
                        </ion-card-header>
                        
                        <ion-card-content>
                            <div id="analysisResults"></div>
                        </ion-card-content>
                    </ion-card>
                </div>

                <!-- Loading Spinner -->
                <ion-modal id="loadingModal" trigger="analyzeBtn">
                    <ion-content class="ion-padding">
                        <div style="text-align: center; padding: 40px;">
                            <ion-spinner style="width: 60px; height: 60px;"></ion-spinner>
                            <ion-text>
                                <h3>Menganalisis Kode...</h3>
                                <p>Sedang memproses permintaan Anda</p>
                            </ion-text>
                        </div>
                    </ion-content>
                </ion-modal>
            </div>
        </ion-content>
    </ion-app>

    <script>
// Konfigurasi
const CONFIG = {
    WORKER_URL: 'https://oktokit-ai.androidbutut.workers.dev/analyze'
};

// Main Analysis Function
async function analyzeCode() {
    const code = codeInput.textContent.trim();
    const language = languageSelect.value;
    const task = taskSelect.value;
    const githubUrlValue = githubUrl.value.trim();

    console.log('Analysis request:', { code, language, task, githubUrlValue });

    if (!code && !githubUrlValue) {
        showError('Masukkan kode atau URL GitHub');
        return;
    }

    // Show loading
    const loadingModal = document.createElement('ion-loading');
    loadingModal.message = 'Menganalisis kode...';
    document.body.appendChild(loadingModal);
    await loadingModal.present();

    try {
        const payload = {
            task: task
        };

        // Only add language if not 'auto'
        if (language !== 'auto') {
            payload.language = language;
        }

        if (githubUrlValue) {
            payload.githubUrl = githubUrlValue;
        } else {
            payload.code = code;
        }

        console.log('Sending payload:', payload);

        const response = await fetch(CONFIG.WORKER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error:', errorText);
            throw new Error(`Server error: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('Analysis result:', result);
        displayResults(result, task);

    } catch (error) {
        console.error('Error:', error);
        showError(`Gagal menganalisis kode: ${error.message}`);
    } finally {
        await loadingModal.dismiss();
        document.body.removeChild(loadingModal);
    }
}

// Display Results dengan error handling
function displayResults(result, task) {
    resultsSection.style.display = 'block';
    
    const taskNames = {
        analyze: 'Analisis Kode',
        fix: 'Perbaikan Kode',
        optimize: 'Optimasi Kode',
        refactor: 'Refactoring Kode',
        explain: 'Penjelasan Kode'
    };

    resultSubtitle.textContent = taskNames[task] || 'Analisis Kode';

    let html = '';

    // Handle errors
    if (result.error) {
        html = `
            <div class="analysis-item" style="border-left-color: var(--ion-color-danger);">
                <h3>Error</h3>
                <p>${result.error}</p>
                ${result.details ? `<p><small>Details: ${result.details}</small></p>` : ''}
            </div>
        `;
    } 
    // Handle raw response
    else if (result.raw_response) {
        html = `
            <div class="analysis-item">
                <h3>Raw Response</h3>
                <pre style="background: #f5f5f5; padding: 12px; border-radius: 4px; overflow-x: auto;">${escapeHtml(result.raw_response)}</pre>
                ${result.parse_error ? `<p class="ion-color-danger">Parse Error: ${result.parse_error}</p>` : ''}
            </div>
        `;
    }
    // Handle successful responses
    else {
        switch (task) {
            case 'analyze':
                html = renderAnalysis(result);
                break;
            case 'fix':
                html = renderFix(result);
                break;
            case 'optimize':
                html = renderOptimization(result);
                break;
            case 'refactor':
                html = renderRefactor(result);
                break;
            case 'explain':
                html = renderExplanation(result);
                break;
            default:
                html = renderDefault(result);
        }
    }

    analysisResults.innerHTML = html;
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}
    </script>
</body>
</html>
